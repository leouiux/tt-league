<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìš©ë¬¸ ë¦¬ê·¸/í† ë„ˆë¨¼íŠ¸</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f7;
  --surface: #ffffff;
  --surface2: #f7f8fc;
  --border: #e4e8f0;
  --primary: #5b6cf5;
  --primary-dark: #4455e8;
  --primary-light: #eef0fe;
  --accent: #7c3aed;
  --success: #10b981;
  --success-light: #d1fae5;
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --text: #1a1f36;
  --text2: #4f566b;
  --text3: #8898aa;
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow: 0 4px 16px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.06);
  --radius: 14px;
  --radius-sm: 8px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans KR', 'DM Sans', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* â”€â”€ LAYOUT â”€â”€ */
.app-shell { max-width: 1880px; margin: 0 auto; padding: 24px 20px; }

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--surface); border-radius: var(--radius);
  padding: 14px 24px; margin-bottom: 20px;
  box-shadow: var(--shadow-sm); flex-wrap: wrap; gap: 12px;
}
.topbar-brand { display: flex; align-items: center; gap: 10px; }
.topbar-logo {
  width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--accent));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; color: white; box-shadow: 0 4px 12px rgba(91,108,245,0.35);
}
.topbar-name { font-size: 1.15rem; font-weight: 700; color: var(--text); }
.topbar-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.topbar-select {
  padding: 7px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
  font-size: 0.85rem; background: var(--surface2); color: var(--text2); outline: none;
  cursor: pointer; min-width: 180px;
}

/* â”€â”€ BUTTONS â”€â”€ */
button { cursor: pointer; font-family: inherit; transition: all 0.18s; border: none; font-weight: 600; white-space: nowrap; }
button:active { transform: scale(0.97); }

.btn { padding: 8px 16px; border-radius: var(--radius-sm); font-size: 0.88rem; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(91,108,245,0.3); }
.btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(91,108,245,0.4); }
.btn-ghost { background: var(--surface2); color: var(--text2); border: 1.5px solid var(--border); }
.btn-ghost:hover { background: var(--border); color: var(--text); }
.btn-success-s { background: var(--success); color: white; }
.btn-success-s:hover { background: #059669; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-warn { background: var(--warning); color: white; }
.btn-warn:hover { background: #d97706; }
.btn-purple { background: var(--accent); color: white; }
.btn-purple:hover { background: #6d28d9; }
.btn-cyan { background: #0891b2; color: white; }
.btn-cyan:hover { background: #0e7490; }
.btn-teal { background: #0d9488; color: white; }
.btn-teal:hover { background: #0f766e; }
.btn-orange { background: #ea580c; color: white; }
.btn-orange:hover { background: #c2410c; }

.btn-lg { padding: 13px 24px; font-size: 1rem; border-radius: var(--radius-sm); }
.btn-full { width: 100%; justify-content: center; }
.btn-sm { padding: 5px 10px; font-size: 0.78rem; border-radius: 6px; }
.btn-xs { padding: 4px 8px; font-size: 0.72rem; border-radius: 5px; }

/* â”€â”€ CARD â”€â”€ */
.card {
  background: var(--surface); border-radius: var(--radius);
  box-shadow: var(--shadow-sm); border: 1.5px solid var(--border);
  padding: 24px;
}
.card-sm { padding: 16px; }

/* â”€â”€ HERO (initial import) â”€â”€ */
.hero-card {
  background: linear-gradient(135deg, #5b6cf5 0%, #7c3aed 100%);
  border-radius: var(--radius); padding: 40px 32px; text-align: center;
  color: white; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(91,108,245,0.35);
}
.hero-card h2 { font-size: 1.6rem; font-weight: 800; margin-bottom: 8px; }
.hero-card p { opacity: 0.85; font-size: 0.95rem; margin-bottom: 24px; }
.hero-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.hero-btn-primary { background: white; color: var(--primary); padding: 11px 24px; border-radius: var(--radius-sm); font-weight: 700; font-size: 0.95rem; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.18s; }
.hero-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
.hero-btn-outline { background: rgba(255,255,255,0.15); color: white; border: 1.5px solid rgba(255,255,255,0.4); padding: 11px 24px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.95rem; cursor: pointer; backdrop-filter: blur(8px); transition: all 0.18s; }
.hero-btn-outline:hover { background: rgba(255,255,255,0.25); }

/* â”€â”€ SETUP FORM â”€â”€ */
.setup-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px; margin-bottom: 20px;
}
.field { display: flex; flex-direction: column; gap: 6px; }
.field label { font-size: 0.82rem; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
.field input, .field select {
  padding: 10px 13px; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
  font-size: 0.95rem; font-weight: 600; background: var(--surface2); color: var(--text);
  outline: none; font-family: inherit; transition: border-color 0.18s;
}
.field input:focus { border-color: var(--primary); background: white; }
.radio-group { display: flex; gap: 12px; align-items: center; padding: 6px 0; }
.radio-group label { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; font-weight: 600; cursor: pointer; }
.radio-group input[type="radio"] { width: 16px; height: 16px; accent-color: var(--primary); }

/* â”€â”€ NAME INPUTS â”€â”€ */
.name-section-header {
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 10px; margin-bottom: 16px;
}
.name-section-title { font-size: 1.05rem; font-weight: 700; color: var(--text); }
.name-section-actions { display: flex; gap: 8px; flex-wrap: wrap; }

.group-input-card {
  background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 14px;
}
.group-input-label {
  font-size: 0.88rem; font-weight: 800; color: var(--primary);
  margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
}
.name-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px;
}
.p-name {
  padding: 9px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
  font-size: 0.9rem; font-weight: 600; text-align: center; background: var(--surface);
  color: var(--text); outline: none; font-family: inherit; transition: border-color 0.18s;
  width: 100%;
}
.p-name:focus { border-color: var(--primary); }

/* â”€â”€ LEAGUE DASHBOARD â”€â”€ */
.group-section {
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}
.group-header {
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 10px; margin-bottom: 18px;
  padding-bottom: 14px; border-bottom: 1.5px solid var(--border);
}
.group-header-left { display: flex; align-items: center; gap: 12px; }
.group-badge {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white; padding: 6px 14px; border-radius: 100px;
  font-weight: 800; font-size: 1rem; letter-spacing: 0.5px;
}
.group-header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.group-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }

/* â”€â”€ TABLE â”€â”€ */
.table-wrap { overflow-x: auto; border-radius: var(--radius-sm); border: 1.5px solid var(--border); }
table { width: 100%; min-width: 380px; border-collapse: collapse; background: var(--surface); }
th, td { border: 1px solid var(--border); padding: 8px 6px; text-align: center; font-size: 0.85rem; }
th { background: var(--surface2); font-weight: 700; color: var(--text2); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.3px; position: sticky; top: 0; z-index: 1; }
th.sortable { cursor: pointer; color: var(--primary); }
th.sortable:hover { background: var(--primary-light); }
.matrix-select { width: 100%; border: none; font-size: 0.85rem; font-weight: 600; text-align-last: center; cursor: pointer; padding: 4px 2px; background: transparent; font-family: inherit; }
.cell-winner { background: var(--success-light) !important; }

/* Standings badges */
.badge { display: inline-block; padding: 2px 8px; border-radius: 100px; font-size: 0.75rem; font-weight: 700; }
.badge-promote { background: var(--success-light); color: #065f46; }
.badge-elim { background: var(--danger-light); color: #991b1b; }

/* â”€â”€ TOURNAMENT BRACKET â”€â”€ */
.tournament-wrap {
  overflow-x: auto; overflow-y: visible; padding: 24px 16px 32px 16px;
  background: linear-gradient(135deg, #f0f2f7 0%, #eef0fe 100%);
  border-radius: var(--radius); border: 1.5px solid var(--border);
}
.bracket-row {
  display: flex; align-items: stretch; width: max-content; min-width: 100%; gap: 0;
}
.bracket-col { display: flex; flex-direction: column; }
.bracket-col-title {
  text-align: center; padding: 7px 16px; background: var(--primary);
  color: white; border-radius: 100px; font-size: 0.82rem; font-weight: 800;
  margin: 0 12px 12px 12px; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(91,108,245,0.35);
}
.bracket-col.col-final .bracket-col-title {
  background: linear-gradient(135deg, var(--warning), #d97706);
  box-shadow: 0 4px 12px rgba(245,158,11,0.4);
}
.bracket-matches { display: flex; flex-direction: column; flex: 1; }
.bracket-slot {
  display: flex; align-items: center; flex: 1; position: relative;
  min-height: 106px;
}
.match-card {
  width: 190px; flex-shrink: 0;
  background: var(--surface); border-radius: 10px;
  border: 1.5px solid var(--border);
  box-shadow: var(--shadow-sm);
  overflow: hidden; position: relative;
  transition: box-shadow 0.18s;
  display: flex; flex-direction: column;
}
.match-card:hover { box-shadow: var(--shadow); }
.match-card.final-card { border-color: var(--warning); box-shadow: 0 4px 16px rgba(245,158,11,0.2); }

.mrow {
  display: flex; align-items: center; padding: 0 10px;
  flex: 1; border-bottom: 1px solid var(--border);
  gap: 6px; transition: background 0.15s; min-height: 0;
}
.mrow:last-of-type { border-bottom: none; }
.mrow.mwinner { background: var(--success-light); }
.mrow.mwalkover { background: #eff6ff; color: #1d4ed8; }
.mrow.mbye { background: var(--surface2); }
.mrow label { cursor: pointer; flex: 1; display: flex; align-items: center; gap: 5px; font-size: 0.82rem; font-weight: 600; color: var(--text); }
.mrow input[type="radio"] { flex-shrink: 0; width: 14px; height: 14px; accent-color: var(--primary); cursor: pointer; }
.seed-pill {
  flex-shrink: 0; background: var(--primary-light); color: var(--primary);
  font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 100px;
  white-space: nowrap;
}
.match-vs {
  text-align: center; font-size: 0.68rem; font-weight: 800; color: var(--text3);
  padding: 2px 0; background: var(--surface2); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
}
.match-footer {
  display: flex; justify-content: flex-end; padding: 4px 8px;
  background: var(--surface2); border-top: 1px solid var(--border);
}
.btn-print-match {
  background: var(--surface); color: var(--primary); border: 1.5px solid var(--border);
  padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 700; cursor: pointer;
}
.btn-print-match:hover { background: var(--primary); color: white; }

/* SVG connector */
.bracket-svg { position: absolute; top: 0; left: 0; pointer-events: none; overflow: visible; }

/* champion */
.champion-banner {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid var(--warning); border-radius: var(--radius);
  padding: 32px; text-align: center; margin-top: 20px;
}
.champion-banner h3 { font-size: 1.4rem; color: #92400e; margin-bottom: 8px; }
.champion-name { font-size: 2.2rem; font-weight: 900; color: #78350f; }

/* â”€â”€ MODAL â”€â”€ */
.modal-bg {
  display: none; position: fixed; inset: 0;
  background: rgba(15,20,40,0.55); backdrop-filter: blur(4px);
  z-index: 999; justify-content: center; align-items: center; padding: 20px;
}
.modal-bg.active { display: flex; }
.modal {
  background: var(--surface); border-radius: var(--radius);
  box-shadow: var(--shadow-lg); width: 100%; max-width: 520px;
  max-height: 90vh; overflow-y: auto; padding: 24px;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.modal-title { font-size: 1.05rem; font-weight: 800; color: var(--text); }
.modal-close { background: var(--surface2); border: 1.5px solid var(--border); color: var(--text2); width: 30px; height: 30px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

/* bulk popup */
.bulk-modal { max-width: 320px; }
.bulk-modal textarea {
  width: 100%; height: 300px; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px; font-size: 0.9rem; resize: none; font-family: inherit; margin: 12px 0;
  outline: none; color: var(--text);
}
.bulk-modal textarea:focus { border-color: var(--primary); }

/* history table */
.hist-table th, .hist-table td { padding: 10px 8px; font-size: 0.85rem; }

/* â”€â”€ TITLE BANNER â”€â”€ */
.title-banner {
  background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
  border-radius: var(--radius); padding: 20px 28px; margin-bottom: 20px;
  display: flex; align-items: center; gap: 16px;
  box-shadow: 0 6px 24px rgba(91,108,245,0.28);
}
.title-banner-icon {
  font-size: 2rem; width: 52px; height: 52px; border-radius: 14px;
  background: rgba(255,255,255,0.18); display: flex; align-items: center;
  justify-content: center; flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
.title-banner-text { flex: 1; }
.title-banner-name {
  font-size: 1.45rem; font-weight: 900; color: white;
  letter-spacing: -0.3px; line-height: 1.2;
}
.title-banner-meta {
  font-size: 0.82rem; color: rgba(255,255,255,0.75);
  margin-top: 3px; font-weight: 500;
}


.section-label { font-size: 0.78rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 10px; }
.sub-title { font-size: 0.95rem; font-weight: 700; color: var(--text); margin-bottom: 12px; }

/* â”€â”€ UTILITIES â”€â”€ */
.hidden { display: none !important; }
.mt16 { margin-top: 16px; }
.mt24 { margin-top: 24px; }
.flex { display: flex; }
.gap8 { gap: 8px; }
.gap12 { gap: 12px; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.flex-wrap { flex-wrap: wrap; }
.w-full { width: 100%; }
.text-primary { color: var(--primary); }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (min-width: 900px) {
  .app-shell { padding: 28px 28px; }
  .group-layout { grid-template-columns: 1fr 420px; }
}
@media (min-width: 1200px) {
  .setup-grid { grid-template-columns: repeat(6, 1fr); }
}
@media print {
  body { background: white; }
  .topbar, button, .modal-bg { display: none !important; }
  .app-shell { padding: 0; }
}
</style>
</head>
<body>
<div class="app-shell">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">ğŸ“</div>
      <span class="topbar-name">ìš©ë¬¸ ë¦¬ê·¸ Â· í† ë„ˆë¨¼íŠ¸</span>
    </div>
    <div class="topbar-actions">
      <select class="topbar-select" id="leagueHistorySelector">
        <option value="">-- ê³¼ê±° ëŒ€íšŒ ì„ íƒ --</option>
      </select>
      <button class="btn btn-ghost" id="viewHistoryBtn">ğŸ“‹ ê¸°ë¡</button>
      <div id="activeControls" class="hidden flex gap8 flex-wrap">
        <button class="btn btn-ghost" id="saveDataBtn">ğŸ’¾ ì €ì¥</button>
        <button class="btn btn-ghost" id="exportJsonBtn">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-ghost" id="importJsonBtn">ğŸ“‚ ê°€ì ¸ì˜¤ê¸°</button>
        <input type="file" id="jsonFileInput" accept=".json" style="display:none">
        <button class="btn btn-primary" id="goToTournamentBtn">ğŸ† í† ë„ˆë¨¼íŠ¸</button>
        <button class="btn btn-ghost" onclick="location.reload()">ğŸ”„ ìƒˆ ëŒ€íšŒ</button>
      </div>
    </div>
  </div>

  <!-- HERO: initial import -->
  <div id="initialImport" class="hero-card">
    <h2>ğŸ† ìš©ë¬¸ ë¦¬ê·¸ Â· í† ë„ˆë¨¼íŠ¸ ìš´ì˜ì‹œìŠ¤í…œ</h2>
    <p>ë¦¬ê·¸ì „ ê²°ê³¼ ê´€ë¦¬ë¶€í„° í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œê¹Œì§€ í•œë²ˆì—</p>
    <div class="hero-btns">
      <button class="hero-btn-primary" id="initialImportBtn">ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="hero-btn-outline" id="startNewLeagueBtn">â• ìƒˆ ëŒ€íšŒ ì‹œì‘</button>
    </div>
    <input type="file" id="initialJsonFileInput" accept=".json" style="display:none">
  </div>

  <!-- SETUP -->
  <div id="setupArea" class="hidden">
    <div class="card">
      <div class="section-label">ëŒ€íšŒ ì„¤ì •</div>
      <div class="setup-grid">
        <div class="field"><label>ë‚ ì§œ</label><input type="date" id="leagueDate"></div>
        <div class="field" style="grid-column: span 2;"><label>ëŒ€íšŒëª…</label><input type="text" id="leagueTitle" placeholder="ì˜ˆ: 2026.02 ìš©ë¬¸ë¦¬ê·¸"></div>
        <div class="field"><label>ì¡° ê°œìˆ˜</label><input type="number" id="groupCount" value="4" min="1"></div>
        <div class="field"><label>ì¡°ë³„ ì¸ì›</label><input type="number" id="playerCount" value="8" min="2"></div>
        <div class="field"><label>íƒˆë½ì¸ì›(ì¡°ë‹¹)</label><input type="number" id="eliminateCount" value="1" min="0"></div>
        <div class="field">
          <label>ê²½ê¸° ë°©ì‹</label>
          <div class="radio-group">
            <label><input type="radio" name="gameRule" value="2" checked> 2ì„ ìŠ¹</label>
            <label><input type="radio" name="gameRule" value="3"> 3ì„ ìŠ¹</label>
          </div>
        </div>
      </div>
      <button class="btn btn-primary btn-lg btn-full" id="prepareNamesBtn">1ë‹¨ê³„: ì„ ìˆ˜ ëª…ë‹¨ ì…ë ¥ì°½ ìƒì„±</button>
    </div>

    <div id="nameInputArea" class="hidden mt24">
      <div class="card">
        <div class="name-section-header">
          <div class="name-section-title">ğŸ‘¤ ì„ ìˆ˜ ëª…ë‹¨ ì…ë ¥</div>
          <div class="name-section-actions">
            <button class="btn btn-cyan btn-sm" id="bulkInputBtn">ğŸ“‹ í•œë²ˆì— ë“±ë¡</button>
            <button class="btn btn-warn btn-sm" id="directTournamentBtn">âš¡ í† ë„ˆë¨¼íŠ¸ ë°”ë¡œì§„í–‰</button>
          </div>
        </div>
        <div id="nameInputs"></div>
        <div class="mt16">
          <button class="btn btn-primary btn-lg btn-full" id="startLeagueBtn">2ë‹¨ê³„: ì „ì²´ ì¡° ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„± (ëœë¤ ë°°ì¹˜)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN DASHBOARD -->
  <div id="mainDashboard" class="hidden mt24">
    <div id="leagueTitleBanner"></div>
    <div id="allGroupsContainer"></div>
  </div>

  <!-- TOURNAMENT -->
  <div id="tournamentArea" class="hidden mt24">
    <div class="card" style="padding:16px 20px; margin-bottom:16px;">
      <div class="flex items-center justify-between flex-wrap gap8">
        <div class="flex items-center gap12">
          <div style="background:linear-gradient(135deg,var(--primary),var(--accent));width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;box-shadow:0 4px 12px rgba(91,108,245,0.3);">ğŸ†</div>
          <div>
            <div style="font-weight:800;font-size:1.05rem;">í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</div>
            <div id="tournamentSubtitle" style="font-size:0.78rem;color:var(--text3);">Single Elimination</div>
          </div>
        </div>
        <button class="btn btn-ghost" id="backToLeagueBtn">â† ë¦¬ê·¸ì „ìœ¼ë¡œ</button>
      </div>
    </div>
    <div id="tournamentTitleBanner"></div>
    <div id="tournamentBracket"></div>
  </div>

</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="modal-bg">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ“‹ ì €ì¥ëœ ëŒ€íšŒ ëª©ë¡</div>
      <button class="modal-close" id="closeHistoryBtn">âœ•</button>
    </div>
    <div class="table-wrap">
      <table class="hist-table">
        <thead><tr><th>ë‚ ì§œ</th><th>ëŒ€íšŒëª…</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="histTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- BULK INPUT MODAL -->
<div id="bulkModal" class="modal-bg">
  <div class="modal bulk-modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ“‹ ì„ ìˆ˜ ëª…ë‹¨ í•œë²ˆì— ë“±ë¡</div>
      <button class="modal-close" id="bulkCancelBtn">âœ•</button>
    </div>
    <div style="font-size:0.8rem;color:var(--text2);line-height:1.7;">
      í•œ í–‰ì— 1ëª…ì”© Â· ë¬¸ì=ì´ë¦„ Â· ìˆ«ì=ë¶€ìˆ˜<br>
      ì˜ˆ) <strong>í™ê¸¸ë™2</strong> Â· ë¶€ìˆ˜ ë‚®ì„ìˆ˜ë¡ ê°•í•¨ â†’ ìë™ êµì°¨ ë°°ë¶„
    </div>
    <textarea id="bulkTextarea" placeholder="í™ê¸¸ë™2&#10;ë§ˆë™íƒ6&#10;ì´ìˆœì‹ 3&#10;..."></textarea>
    <div class="flex gap8">
      <button class="btn btn-primary btn-full" id="bulkConfirmBtn">âœ” ì…ë ¥</button>
      <button class="btn btn-ghost" id="bulkCancelBtn2" style="flex:1;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
let masterData = JSON.parse(localStorage.getItem('league_db')) || {};
let curId = null;
let groupSortOptions = {};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function shuffle(arr) {
  let a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function getGrade(league, name) {
  if (!name) return null;
  for (let g in league.groups || {}) {
    const gr = league.groups[g].grades;
    if (gr && gr[name] !== undefined && gr[name] !== 9999) return gr[name];
  }
  if (league.tournament?.seeds) {
    const s = league.tournament.seeds.find(x => x.name === name);
    if (s && s.grade !== 9999) return s.grade;
  }
  return null;
}

function displayName(league, name) {
  if (!name) return '';
  const g = getGrade(league, name);
  return g !== null ? `${name}(${g})` : name;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('leagueDate').value = new Date().toISOString().split('T')[0];

  document.getElementById('initialImportBtn').addEventListener('click', () => document.getElementById('initialJsonFileInput').click());
  document.getElementById('initialJsonFileInput').addEventListener('change', e => importJson(e, true));
  document.getElementById('startNewLeagueBtn').addEventListener('click', () => {
    document.getElementById('initialImport').classList.add('hidden');
    document.getElementById('setupArea').classList.remove('hidden');
  });
  document.getElementById('prepareNamesBtn').addEventListener('click', prepareNames);
  document.getElementById('startLeagueBtn').addEventListener('click', createLeague);
  document.getElementById('saveDataBtn').addEventListener('click', () => save(false));
  document.getElementById('viewHistoryBtn').addEventListener('click', openHistory);
  document.getElementById('closeHistoryBtn').addEventListener('click', closeHistory);
  document.getElementById('leagueHistorySelector').addEventListener('change', e => { if (e.target.value) loadLeague(e.target.value); });
  document.getElementById('goToTournamentBtn').addEventListener('click', createTournament);
  document.getElementById('backToLeagueBtn').addEventListener('click', backToLeague);
  document.getElementById('exportJsonBtn').addEventListener('click', exportJson);
  document.getElementById('importJsonBtn').addEventListener('click', () => document.getElementById('jsonFileInput').click());
  document.getElementById('jsonFileInput').addEventListener('change', importJson);
  document.getElementById('bulkInputBtn').addEventListener('click', () => document.getElementById('bulkModal').classList.add('active'));
  document.getElementById('bulkCancelBtn').addEventListener('click', closeBulk);
  document.getElementById('bulkCancelBtn2').addEventListener('click', closeBulk);
  document.getElementById('bulkConfirmBtn').addEventListener('click', processBulk);
  document.getElementById('directTournamentBtn').addEventListener('click', directTournament);

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeHistory(); closeBulk(); }
  });
  updateSelector();
});

function closeBulk() { document.getElementById('bulkModal').classList.remove('active'); document.getElementById('bulkTextarea').value = ''; }
function openHistory() { renderHistory(); document.getElementById('historyModal').classList.add('active'); }
function closeHistory() { document.getElementById('historyModal').classList.remove('active'); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ name input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function prepareNames() {
  const gc = parseInt(document.getElementById('groupCount').value);
  const pc = parseInt(document.getElementById('playerCount').value);
  if (gc < 1 || pc < 2) { alert('âš ï¸ ì¡° ê°œìˆ˜ 1ê°œ ì´ìƒ, ì¡°ë³„ ì¸ì› 2ëª… ì´ìƒ'); return; }

  const container = document.getElementById('nameInputs');
  container.innerHTML = '';
  for (let i = 0; i < gc; i++) {
    const gn = String.fromCharCode(65 + i) + 'ì¡°';
    let inputs = '';
    for (let j = 0; j < pc; j++) inputs += `<input type="text" class="p-name" data-group="${gn}" placeholder="">`;
    container.innerHTML += `
      <div class="group-input-card">
        <div class="group-input-label">${gn} ëª…ë‹¨</div>
        <div class="name-grid">${inputs}</div>
      </div>`;
  }
  document.getElementById('nameInputArea').classList.remove('hidden');
  setTimeout(() => document.getElementById('nameInputArea').scrollIntoView({ behavior: 'smooth' }), 100);
}

function processBulk() {
  const text = document.getElementById('bulkTextarea').value.trim();
  if (!text) { closeBulk(); return; }

  const players = text.split('\n').map(l => l.trim()).filter(l => l).map(line => {
    const nm = line.match(/^[^\d]+/); const gm = line.match(/\d+/);
    return { full: line.trim(), name: nm ? nm[0].trim() : line.trim(), grade: gm ? parseInt(gm[0]) : 9999 };
  }).filter(p => p.name).sort((a, b) => a.grade - b.grade);

  const containers = document.querySelectorAll('.group-input-card');
  if (!containers.length) { alert('ë¨¼ì € ì…ë ¥ì°½ì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
  document.querySelectorAll('.p-name').forEach(el => el.value = '');

  const groups = Array.from(containers).map(c => Array.from(c.querySelectorAll('.p-name')));
  const gc = groups.length;
  let pi = 0, si = 0;
  while (pi < players.length) {
    const round = Math.floor(si / gc);
    const pos = si % gc;
    const gi = round % 2 === 0 ? pos : gc - 1 - pos;
    if (gi < groups.length) {
      const slot = groups[gi].find(el => !el.value);
      if (slot) { slot.value = players[pi].full; pi++; }
    }
    si++;
    if (si > gc * groups[0].length * 3 + 100) break;
  }
  closeBulk();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ create league â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function parsePlayer(rawVal) {
  const nm = rawVal.match(/^[^\d]+/); const gm = rawVal.match(/\d+/);
  return { name: nm ? nm[0].trim() : rawVal, grade: gm ? parseInt(gm[0]) : 9999 };
}

function createLeague() {
  const id = Date.now().toString();
  const league = {
    id,
    date: document.getElementById('leagueDate').value,
    title: document.getElementById('leagueTitle').value || 'ìš©ë¬¸ë¦¬ê·¸',
    targetWins: parseInt(document.querySelector('input[name="gameRule"]:checked').value),
    eliminateCount: parseInt(document.getElementById('eliminateCount').value) || 0,
    groups: {}
  };

  document.querySelectorAll('.p-name').forEach(el => {
    const g = el.dataset.group; const raw = el.value.trim();
    if (!raw) return;
    if (!league.groups[g]) league.groups[g] = { names: [], results: {}, playerIds: {}, grades: {} };
    const { name, grade } = parsePlayer(raw);
    if (name) { league.groups[g].names.push(name); league.groups[g].grades[name] = grade; }
  });

  for (let g in league.groups) {
    league.groups[g].names = shuffle(league.groups[g].names);
    league.groups[g].names.forEach((n, i) => { league.groups[g].playerIds[n] = i + 1; });
    league.groups[g].names.forEach(n1 => {
      league.groups[g].results[n1] = {};
      league.groups[g].names.forEach(n2 => {
        if (n1 !== n2) league.groups[g].results[n1][n2] = { s1: 0, s2: 0, done: false };
      });
    });
    groupSortOptions[g] = { key: 'rank', order: 'asc' };
  }

  masterData[id] = league;
  save(true);
  document.getElementById('initialImport').classList.add('hidden');
  loadLeague(id);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ direct tournament â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function directTournament() {
  const all = [];
  document.querySelectorAll('.p-name').forEach(el => {
    const raw = el.value.trim(); if (!raw) return;
    const { name, grade } = parsePlayer(raw);
    if (name) all.push({ name, grade, seed: '', isEliminated: false, rank: 1, group: '-' });
  });
  if (all.length < 2) { alert('ìµœì†Œ 2ëª… ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

  const players = shuffle(all);
  players.forEach((p, i) => { p.seed = `${i + 1}ë²ˆ`; });

  const id = Date.now().toString();
  const bracket = buildBracket(players, true);
  masterData[id] = {
    id,
    date: document.getElementById('leagueDate').value,
    title: document.getElementById('leagueTitle').value || 'ìš©ë¬¸ë¦¬ê·¸',
    targetWins: 2, eliminateCount: 0, groups: {},
    tournament: { seeds: players, rounds: bracket, champion: null }
  };
  curId = id;
  save(true);
  document.getElementById('setupArea').classList.add('hidden');
  document.getElementById('activeControls').classList.remove('hidden');
  document.getElementById('mainDashboard').classList.add('hidden');
  showTournament();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ load league â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadLeague(id) {
  if (!id) return;
  curId = id;
  const d = masterData[id];
  document.getElementById('initialImport').classList.add('hidden');
  document.getElementById('setupArea').classList.add('hidden');
  document.getElementById('activeControls').classList.remove('hidden');

  if (!d.groups || Object.keys(d.groups).length === 0) {
    document.getElementById('mainDashboard').classList.add('hidden');
    showTournament(); return;
  }

  document.getElementById('mainDashboard').classList.remove('hidden');
  document.getElementById('tournamentArea').classList.add('hidden');

  // ëŒ€íšŒëª… ë°°ë„ˆ ë Œë”
  const banner = document.getElementById('leagueTitleBanner');
  banner.innerHTML = `
    <div class="title-banner">
      <div class="title-banner-icon">ğŸ“</div>
      <div class="title-banner-text">
        <div class="title-banner-name">${d.title || 'ìš©ë¬¸ë¦¬ê·¸'}</div>
        <div class="title-banner-meta">${d.date || ''} &nbsp;Â·&nbsp; ë¦¬ê·¸ì „ ëŒ€ì§„í‘œ &nbsp;Â·&nbsp; ${Object.keys(d.groups).length}ê°œ ì¡°</div>
      </div>
    </div>`;

  const container = document.getElementById('allGroupsContainer');
  container.innerHTML = '';

  Object.keys(d.groups).forEach(gn => {
    if (!groupSortOptions[gn]) groupSortOptions[gn] = { key: 'rank', order: 'asc' };
    const sec = document.createElement('div');
    sec.className = 'group-section';
    sec.innerHTML = `
      <div class="group-header">
        <div class="group-header-left">
          <div class="group-badge">${gn}</div>
        </div>
        <div class="group-header-actions">
          <button class="btn btn-orange btn-sm" onclick="randomFillGroup('${gn}')">ğŸ² Testëœë¤ê²°ê³¼ì…ë ¥</button>
          <button class="btn btn-purple btn-sm" onclick="printGroupMatrix('${gn}')">ğŸ–¨ï¸ ëŒ€ì§„í‘œ ì¸ì‡„</button>
        </div>
      </div>
      <div class="group-layout">
        <div>
          <div class="section-label">ê²°ê³¼ ë§¤íŠ¸ë¦­ìŠ¤</div>
          <div class="table-wrap"><table><thead id="head-${gn}"></thead><tbody id="body-${gn}"></tbody></table></div>
        </div>
        <div>
          <div class="section-label">ìˆœìœ„í‘œ</div>
          <div class="table-wrap">
            <table id="standings-${gn}">
              <thead><tr>
                <th class="sortable" onclick="handleSort('${gn}','id')">IDâ†•</th>
                <th>ì´ë¦„</th><th>ì „ì </th><th>ë“ì‹¤</th><th>ìŠ¹ì </th>
                <th class="sortable" onclick="handleSort('${gn}','rank')">ìˆœìœ„â†•</th><th>ê²°ê³¼</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>`;
    container.appendChild(sec);
    renderMatrix(gn);
    updateStandings(gn);
  });

  setTimeout(() => document.getElementById('mainDashboard').scrollIntoView({ behavior: 'smooth' }), 100);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ random fill (test) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.randomFillGroup = function(gn) {
  const d = masterData[curId];
  const g = d.groups[gn];
  const max = d.targetWins;
  g.names.forEach(n1 => g.names.forEach(n2 => {
    if (n1 >= n2) return;
    const a = Math.floor(Math.random() * max); // 0 ~ max-1
    const s1 = max, s2 = a; // winner is n1
    const flip = Math.random() < 0.5;
    const final1 = flip ? a : max;
    const final2 = flip ? max : a;
    g.results[n1][n2] = { s1: final1, s2: final2, done: true };
    g.results[n2][n1] = { s1: final2, s2: final1, done: true };
  }));
  save(true);
  renderMatrix(gn);
  updateStandings(gn);
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMatrix(gn) {
  const d = masterData[curId]; const g = d.groups[gn];
  document.getElementById(`head-${gn}`).innerHTML =
    `<th>ì„ ìˆ˜</th>` + g.names.map(n => `<th style="white-space:nowrap;">${displayName(d, n)}</th>`).join('');
  document.getElementById(`body-${gn}`).innerHTML = g.names.map(n1 => `
    <tr>
      <td style="font-weight:700;background:var(--surface2);white-space:nowrap;text-align:left;padding-left:10px;">${displayName(d, n1)}</td>
      ${g.names.map(n2 => {
        if (n1 === n2) return `<td style="background:#f1f5f9;color:#94a3b8;">â€”</td>`;
        const r = g.results[n1][n2];
        return `<td class="${r.done && r.s1 > r.s2 ? 'cell-winner' : ''}">
          <select class="matrix-select" onchange="updateScore('${gn}','${n1}','${n2}',this.value)">
            ${getOptions(d.targetWins, `${r.s1}:${r.s2}`)}
          </select></td>`;
      }).join('')}
    </tr>`).join('');
}

function getOptions(max, cur) {
  let h = `<option value="0:0" ${cur==='0:0'?'selected':''}>â€”</option>`;
  for (let i = 0; i < max; i++) h += `<option value="${max}:${i}" ${cur===`${max}:${i}`?'selected':''}>${max}:${i}</option>`;
  for (let i = 0; i < max; i++) h += `<option value="${i}:${max}" ${cur===`${i}:${max}`?'selected':''}>${i}:${max}</option>`;
  return h;
}

window.updateScore = (gn, p1, p2, val) => {
  const [s1, s2] = val.split(':').map(Number);
  const g = masterData[curId].groups[gn];
  g.results[p1][p2] = { s1, s2, done: s1 > 0 || s2 > 0 };
  g.results[p2][p1] = { s1: s2, s2: s1, done: s1 > 0 || s2 > 0 };
  renderMatrix(gn); updateStandings(gn);
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ standings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function computeStats(gn) {
  const g = masterData[curId].groups[gn];
  const manualRanks = g.manualRanks || {};

  // 1. ê¸°ë³¸ ìŠ¤íƒ¯ ê³„ì‚°
  let stats = g.names.map(name => {
    let s = { id: g.playerIds[name], name, w: 0, l: 0, sW: 0, sL: 0, pts: 0 };
    g.names.forEach(opp => {
      if (name === opp) return;
      const m = g.results[name][opp];
      if (m?.done) {
        s.sW += m.s1; s.sL += m.s2;
        m.s1 > m.s2 ? (s.w++, s.pts += 2) : (s.l++, s.pts += 1);
      }
    });
    s.diff = s.sW - s.sL;
    return s;
  });

  const totalMatches = g.names.length * (g.names.length - 1) / 2;
  const done = g.names.reduce((c, n1) => c + g.names.filter(n2 => n1 < n2 && g.results[n1][n2]?.done).length, 0);
  const noRes = done === 0;
  const allMatchesDone = done === totalMatches;
  const ec = masterData[curId].eliminateCount || 0;

  // 2. 1ì°¨ ì •ë ¬: ìŠ¹ì  â†’ ì „ì²´ ì„¸íŠ¸ ë“ì‹¤ì°¨
  let ranked = [...stats].sort((a, b) => b.pts - a.pts || b.diff - a.diff);

  // 3. ë™ë¥  ê·¸ë£¹ ì²˜ë¦¬
  let i = 0;
  while (i < ranked.length) {
    let j = i + 1;
    while (j < ranked.length && ranked[j].pts === ranked[i].pts && ranked[j].diff === ranked[i].diff) j++;
    const tieGroup = ranked.slice(i, j);

    if (tieGroup.length > 1 && !noRes) {
      // ê° ì„ ìˆ˜ì— ë™ë¥  ë‚´ í†µê³„ ë¶€ì—¬
      const enriched = tieGroup.map(p => {
        let h2hW = 0, h2hSW = 0, h2hSL = 0;
        tieGroup.forEach(o => {
          if (p.name === o.name) return;
          const m = g.results[p.name][o.name];
          if (m?.done) { h2hSW += m.s1; h2hSL += m.s2; if (m.s1 > m.s2) h2hW++; }
        });
        return { ...p, h2hW, h2hDiff: h2hSW - h2hSL };
      });

      // ìš°ì„ ìˆœìœ„: â‘  ìŠ¹ììŠ¹(h2hW) â†’ â‘¡ ë™ë¥ ê°„ ì„¸íŠ¸ë“ì‹¤(h2hDiff) â†’ â‘¢ ì „ì²´ì„¸íŠ¸ë“ì‹¤(diff) â†’ â‘£ ìˆ˜ë™ì„ íƒ
      enriched.sort((a, b) => {
        if (b.h2hW !== a.h2hW) return b.h2hW - a.h2hW;
        if (b.h2hDiff !== a.h2hDiff) return b.h2hDiff - a.h2hDiff;
        if (b.diff !== a.diff) return b.diff - a.diff;
        // ìˆ˜ë™ì„ íƒ: manualRanks ê¸°ì¤€
        const mA = manualRanks[a.name], mB = manualRanks[b.name];
        if (mA !== undefined && mB !== undefined) return mA - mB;
        if (mA !== undefined) return -1;
        if (mB !== undefined) return 1;
        return 0;
      });

      enriched.forEach((p, k) => { ranked[i + k] = p; });
    }
    i = j;
  }

  // 4. ìµœì¢… rank ë¶€ì—¬ ë° ì™„ì „ë™ë¥ (ìˆ˜ë™ì„ íƒ í•„ìš”) ê°ì§€
  let cr = 1;
  ranked.forEach((p, idx) => {
    p.isTied = false;
    p.needsManual = false;
    if (idx === 0) { p.rank = cr; }
    else {
      const prev = ranked[idx - 1];
      const sameH2H = (p.h2hW !== undefined && prev.h2hW !== undefined)
        ? (p.h2hW === prev.h2hW && p.h2hDiff === prev.h2hDiff && p.diff === prev.diff)
        : (p.pts === prev.pts && p.diff === prev.diff);
      if (!noRes && sameH2H) {
        // ìˆ˜ë™ì„ íƒìœ¼ë¡œ êµ¬ë¶„ëëŠ”ì§€ í™•ì¸
        const mA = manualRanks[prev.name], mB = manualRanks[p.name];
        if (mA !== undefined && mB !== undefined && mA !== mB) {
          cr = idx + 1; p.rank = cr;
        } else {
          p.rank = prev.rank; p.isTied = prev.isTied = true;
          // ìˆ˜ë™ì„ íƒ selectëŠ” ëª¨ë“  ê²½ê¸°ê°€ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í‘œì‹œ
          if (allMatchesDone) { p.needsManual = prev.needsManual = true; }
        }
      } else { cr = idx + 1; p.rank = cr; }
    }
    p.isEliminated = noRes ? false : ec > 0 && p.rank > ranked.length - ec;
    const x = stats.find(s => s.name === p.name);
    Object.assign(x, { rank: p.rank, isTied: p.isTied, needsManual: p.needsManual, isEliminated: p.isEliminated, h2hW: p.h2hW, h2hDiff: p.h2hDiff });
  });
  return { stats, ranked };
}

function updateStandings(gn) {
  const { stats, ranked } = computeStats(gn);
  const ec = masterData[curId].eliminateCount || 0;
  const opt = groupSortOptions[gn];
  const d = masterData[curId];
  const g = d.groups[gn];
  const manualRanks = g.manualRanks || {};
  const sorted = [...stats].sort((a, b) => opt.order === 'asc' ? (a[opt.key] > b[opt.key] ? 1 : -1) : (a[opt.key] < b[opt.key] ? 1 : -1));

  document.querySelector(`#standings-${gn} tbody`).innerHTML = sorted.map(s => {
    const rowBg = s.needsManual ? 'background:#fff7ed;' : (s.isTied ? 'background:#fef3c7;' : '');
    let badge = '';
    if (ec > 0) badge = s.isEliminated ? '<span class="badge badge-elim">íƒˆë½</span>' : '<span class="badge badge-promote">ì§„ì¶œ</span>';

    // ì™„ì „ë™ë¥  â†’ select ë°•ìŠ¤ë¡œ ìˆœìœ„ ìˆ˜ë™ì„ íƒ
    let rankCell = '';
    if (s.needsManual) {
      const tiedGroup = sorted.filter(x => x.needsManual && x.rank === s.rank || (x.needsManual && sorted.filter(y=>y.needsManual).some(y=>y.rank===x.rank)));
      const allTied = sorted.filter(x => x.needsManual);
      const groupRanks = allTied.map(x => x.rank);
      const minRank = Math.min(...groupRanks);
      const maxRank = Math.min(minRank + allTied.length - 1, ranked.length);
      const options = [];
      for (let r = minRank; r <= maxRank; r++) {
        const sel = (manualRanks[s.name] === r) ? 'selected' : '';
        options.push(`<option value="${r}" ${sel}>${r}ìœ„</option>`);
      }
      rankCell = `<select onchange="setManualRank('${gn}','${s.name}',this.value)" style="font-size:0.78rem;border:1.5px solid var(--warning);border-radius:5px;padding:2px 6px;background:#fff7ed;font-weight:700;cursor:pointer;color:var(--text);outline:none;">
        <option value="">ìˆœìœ„ì„ íƒ</option>${options.join('')}
      </select>`;
    } else {
      rankCell = `<span style="font-weight:800;">${s.rank}</span>${s.isTied ? ' <span style="font-size:0.7rem;color:var(--warning);">ë™ë¥ </span>' : ''}`;
    }

    return `<tr style="${rowBg}">
      <td style="color:var(--text3);">${s.id}</td>
      <td style="font-weight:700;white-space:nowrap;text-align:left;padding-left:8px;">${displayName(d, s.name)}</td>
      <td>${s.w} / ${s.l}</td>
      <td style="font-weight:700;color:${s.diff>0?'var(--success)':s.diff<0?'var(--danger)':'var(--text3)'};">${s.diff>0?'+':''}${s.diff}</td>
      <td style="font-weight:700;color:var(--primary);">${s.pts}</td>
      <td>${rankCell}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

window.handleSort = (gn, key) => {
  const o = groupSortOptions[gn];
  if (o.key === key) o.order = o.order === 'asc' ? 'desc' : 'asc'; else { o.key = key; o.order = 'asc'; }
  updateStandings(gn);
};

window.setManualRank = function(gn, playerName, rankVal) {
  const g = masterData[curId].groups[gn];
  if (!g.manualRanks) g.manualRanks = {};
  if (rankVal === '' || rankVal === null) {
    delete g.manualRanks[playerName];
  } else {
    g.manualRanks[playerName] = parseInt(rankVal);
  }
  save(true);
  updateStandings(gn);
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tournament â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function createTournament() {
  if (!curId) { alert('âš ï¸ ë¨¼ì € ë¦¬ê·¸ì „ì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
  const league = masterData[curId];
  const ec = league.eliminateCount || 0;
  const seeds = [];
  const gnames = Object.keys(league.groups).sort();
  if (!gnames.length) { showTournament(); return; }

  const maxPPG = Math.max(...gnames.map(g => league.groups[g].names.length));
  for (let rank = 1; rank <= maxPPG; rank++) {
    gnames.forEach(gn => {
      const ranked = computeStats(gn).ranked;
      const p = ranked.find(x => x.rank === rank);
      if (p) {
        seeds.push({
          name: p.name, group: gn, rank,
          seed: `${gn} ${rank}ìœ„`,
          isEliminated: ec > 0 && p.rank > ranked.length - ec,
          grade: league.groups[gn].grades[p.name] || 9999
        });
      }
    });
  }

  if (league.tournament && !confirm('ê¸°ì¡´ í† ë„ˆë¨¼íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í• ê¹Œìš”?')) { showTournament(); return; }

  league.tournament = { seeds, rounds: buildBracket(seeds, false), champion: null };
  save(true);
  showTournament();
}

function getSeedOrder(n) {
  if (n === 1) return [0];
  const half = getSeedOrder(n / 2);
  const res = [];
  for (const v of half) { res.push(v); res.push(n - 1 - v); }
  return res;
}

function buildBracket(seeds, isRandom) {
  const active = seeds.filter(s => !s.isEliminated).sort((a, b) => {
    if (isRandom) return 0;
    return a.rank !== b.rank ? a.rank - b.rank : a.grade - b.grade;
  });

  let size = 2;
  while (size < active.length) size *= 2;

  const full = [...active];
  while (full.length < size) full.push(null);

  const order = getSeedOrder(size);
  const slots = order.map(i => full[i]);

  const allRounds = [];
  const round1 = [];
  for (let i = 0; i < size / 2; i++) {
    const p1 = slots[i * 2], p2 = slots[i * 2 + 1];
    let winner = null, completed = false, isWalkover = false;
    if (p1 && !p2) { winner = p1.name; completed = true; isWalkover = true; }
    else if (!p1 && p2) { winner = p2.name; completed = true; isWalkover = true; }
    round1.push({
      id: `r1_${i}`,
      player1: p1?.name || null, player2: p2?.name || null,
      seed1: p1?.seed || '', seed2: p2?.seed || '',
      winner, completed, isWalkover, p1Elim: false, p2Elim: false
    });
  }
  allRounds.push(round1);

  let prev = round1;
  while (prev.length > 1) {
    const next = [];
    for (let i = 0; i < prev.length / 2; i++) {
      const m1 = prev[i * 2], m2 = prev[i * 2 + 1];
      let p1 = m1.winner || null, p2 = m2.winner || null;
      let s1 = m1.winner ? (m1.winner === m1.player1 ? m1.seed1 : m1.seed2) : '';
      let s2 = m2.winner ? (m2.winner === m2.player1 ? m2.seed1 : m2.seed2) : '';
      // ì²« ë¼ìš´ë“œ ì´í›„ ë¶€ì „ìŠ¹ ì—†ìŒ: ìë™ ì§„ì¶œ ì²˜ë¦¬ ì•ˆ í•¨
      next.push({ id: `r${allRounds.length + 1}_${i}`, player1: p1, player2: p2, seed1: s1, seed2: s2, winner: null, completed: false, isWalkover: false, fromMatches: [m1.id, m2.id] });
    }
    allRounds.push(next);
    prev = next;
  }

  const labels = ['ê²°ìŠ¹','ì¤€ê²°ìŠ¹','8ê°•','16ê°•','32ê°•','64ê°•'];
  return allRounds.map((m, idx) => {
    const fe = allRounds.length - 1 - idx;
    return { name: labels[fe] || `${Math.pow(2, fe + 1)}ê°•`, matches: m };
  });
}

function showTournament() {
  document.getElementById('mainDashboard').classList.add('hidden');
  document.getElementById('tournamentArea').classList.remove('hidden');

  // í† ë„ˆë¨¼íŠ¸ ëŒ€íšŒëª… ë°°ë„ˆ
  const d = masterData[curId];
  if (d) {
    const seeds = d.tournament?.seeds || [];
    const playerCount = seeds.filter(s => !s.isEliminated).length;
    document.getElementById('tournamentTitleBanner').innerHTML = `
      <div class="title-banner" style="background:linear-gradient(135deg,#f59e0b 0%,#7c3aed 100%);margin-bottom:16px;">
        <div class="title-banner-icon">ğŸ†</div>
        <div class="title-banner-text">
          <div class="title-banner-name">${d.title || 'ìš©ë¬¸ë¦¬ê·¸'}</div>
          <div class="title-banner-meta">${d.date || ''} &nbsp;Â·&nbsp; í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ &nbsp;Â·&nbsp; ${playerCount}ê°•</div>
        </div>
      </div>`;
    // í† ë„ˆë¨¼íŠ¸ ì¹´ë“œ ì„œë¸Œíƒ€ì´í‹€ì—ë„ ëŒ€íšŒëª… í‘œì‹œ
    const sub = document.getElementById('tournamentSubtitle');
    if (sub) sub.textContent = d.title || 'Single Elimination';
  }

  renderTournament();
  setTimeout(() => document.getElementById('tournamentArea').scrollIntoView({ behavior: 'smooth' }), 100);
}

function backToLeague() {
  document.getElementById('tournamentArea').classList.add('hidden');
  if (masterData[curId] && Object.keys(masterData[curId].groups).length > 0) {
    document.getElementById('mainDashboard').classList.remove('hidden');
    setTimeout(() => document.getElementById('mainDashboard').scrollIntoView({ behavior: 'smooth' }), 100);
  }
}

function renderTournament() {
  const league = masterData[curId];
  if (!league?.tournament) return;
  const container = document.getElementById('tournamentBracket');
  container.innerHTML = '';

  const rounds = league.tournament.rounds;
  if (!rounds?.length) return;

  /*
   * ë ˆì´ì•„ì›ƒ êµ¬ì¡° (ê° ì—´):
   *  [LABEL_W] [BOX_W] [PRINT_W] [GAP] [LABEL_W] [BOX_W] ...
   *
   * ê° ëŒ€ì§„(match-card)ì€ relative div ì•ˆì—:
   *   ì™¼ìª½: ë¼ìš´ë“œ ë ˆì´ë¸” (32ê°• ë“±)
   *   ê°€ìš´ë°: ë§¤ì¹˜ ë°•ìŠ¤
   *   ì˜¤ë¥¸ìª½: ì¸ì‡„ ë²„íŠ¼ (ë¶€ì „ìŠ¹ ì œì™¸)
   */
  const LABEL_W = 50;
  const BOX_W   = 190;
  const PRINT_W = 40;
  const COL_W   = LABEL_W + BOX_W + PRINT_W;  // 308
  const COL_GAP = 32;
  const BOX_H   = 72;
  const SLOT_GAP = 20;
  const SLOT_H  = BOX_H + SLOT_GAP;
  const HEADER_H = 42;
  const PAD_V   = 14;

  const ROUND_N      = rounds.length;
  const FIRST_N      = rounds[0].matches.length;
  const TOTAL_W      = ROUND_N * COL_W + (ROUND_N - 1) * COL_GAP;
  const TOTAL_H      = FIRST_N * SLOT_H + HEADER_H + PAD_V * 2;

  /* â”€â”€ outer wrapper (scroll ì»¨í…Œì´ë„ˆ) â”€â”€ */
  const scrollWrap = document.createElement('div');
  scrollWrap.className = 'tournament-wrap';

  /* â”€â”€ inner absolute canvas â”€â”€ */
  const canvas = document.createElement('div');
  canvas.style.cssText = `position:relative;width:${TOTAL_W}px;height:${TOTAL_H}px;`;

  /* â”€â”€ SVG for connector lines â”€â”€ */
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width', TOTAL_W);
  svg.setAttribute('height', TOTAL_H);
  svg.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;';
  canvas.appendChild(svg);

  const centerYs = []; // centerYs[ri][mi] = center Y of that match card

  rounds.forEach((round, ri) => {
    const isFinal = round.name === 'ê²°ìŠ¹';
    const matchN  = round.matches.length;
    const slotH   = (FIRST_N * SLOT_H) / matchN; // í›„ë°˜ ë¼ìš´ë“œëŠ” ë” ë„“ì€ ìŠ¬ë¡¯
    const colLeft = ri * (COL_W + COL_GAP);
    const boxLeft = colLeft + LABEL_W;
    const cys = [];
    centerYs.push(cys);

    /* ìƒë‹¨ ë¼ìš´ë“œ ì´ë¦„ í—¤ë” */
    const hdr = document.createElement('div');
    hdr.style.cssText = [
      `position:absolute`,
      `left:${boxLeft}px`,`top:${PAD_V}px`,
      `width:${BOX_W}px`,`height:${HEADER_H - 6}px`,
      `display:flex`,`align-items:center`,`justify-content:center`,
      `font-weight:800`,`font-size:0.8rem`,`letter-spacing:0.4px`,
      `border-radius:100px`,`box-sizing:border-box`,
      isFinal
        ? `color:white;background:linear-gradient(135deg,#f59e0b,#d97706);border:1.5px solid #f59e0b;`
        : `color:var(--primary);background:var(--primary-light);border:1.5px solid var(--primary);`
    ].join(';');
    hdr.textContent = round.name;
    canvas.appendChild(hdr);

    round.matches.forEach((match, mi) => {
      const slotTop = HEADER_H + PAD_V + mi * slotH;
      const boxTop  = slotTop + (slotH - BOX_H) / 2;
      const cy      = boxTop + BOX_H / 2;
      cys.push(cy);

      const isWO     = match.isWalkover || false;
      const canVote  = match.player1 && match.player2 && !isWO;

      /* â”€â”€ ì™¼ìª½ ë¼ìš´ë“œ ë ˆì´ë¸” â”€â”€ */
      const lbl = document.createElement('div');
      lbl.style.cssText = [
        `position:absolute`,
        `left:${colLeft}px`,`top:${boxTop}px`,
        `width:${LABEL_W - 4}px`,`height:${BOX_H}px`,
        `display:flex`,`align-items:center`,`justify-content:center`,
      ].join(';');
      lbl.innerHTML = `<span style="
        font-size:0.68rem;font-weight:800;line-height:1.3;text-align:center;
        white-space:nowrap;padding:4px 5px;border-radius:6px;
        ${isFinal
          ? 'color:#92400e;background:#fef3c7;border:1.5px solid #f59e0b;'
          : 'color:var(--primary);background:var(--primary-light);border:1.5px solid var(--primary);'
        }
      ">${round.name}</span>`;
      canvas.appendChild(lbl);

      /* â”€â”€ ë§¤ì¹˜ ì¹´ë“œ â”€â”€ */
      const makeRow = (name, isP1) => {
        const seed   = isP1 ? match.seed1 : match.seed2;
        const isWin  = !!(match.winner && match.winner === name);
        const isBye  = isWO && !name;
        const dname  = name ? displayName(league, name) : '';
        const label  = isBye ? 'BYE' : (isWO && isWin ? `${dname} (ë¶€ì „ìŠ¹)` : (dname || ''));
        let rowCls   = 'mrow';
        if (isWin && !isWO) rowCls += ' mwinner';
        if (isWin && isWO)  rowCls += ' mwalkover';
        if (isBye)          rowCls += ' mbye';
        const radio  = canVote && name
          ? `<input type="radio" name="m_${match.id}" id="${match.id}_p${isP1?1:2}" ${isWin?'checked':''} onchange="selectWinner('${match.id}',${isP1?1:2})">`
          : '';
        const badge  = ri === 0 && seed
          ? `<span class="seed-pill">${seed}</span>` : '';
        return `<div class="${rowCls}" style="height:${BOX_H/2 - 0.5}px;min-height:0;">
          <label for="${match.id}_p${isP1?1:2}" style="${isBye?'color:#94a3b8;font-style:italic;':''}">
            ${radio}${badge}<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
          </label>
        </div>`;
      };

      const card = document.createElement('div');
      card.className = `match-card${isFinal ? ' final-card' : ''}`;
      card.style.cssText = `position:absolute;left:${boxLeft}px;top:${boxTop}px;width:${BOX_W}px;height:${BOX_H}px;overflow:hidden;`;
      card.innerHTML = `
        ${makeRow(match.player1, true)}
        <div style="height:1px;background:var(--border);flex-shrink:0;"></div>
        ${makeRow(match.player2, false)}
      `;
      canvas.appendChild(card);

      /* â”€â”€ ì¸ì‡„ ë²„íŠ¼ (ë¶€ì „ìŠ¹ ì œì™¸) â”€â”€ */
      if (!isWO) {
        const pBtn = document.createElement('button');
        pBtn.className = 'btn-print-match';
        pBtn.title = 'ê²½ê¸° ì¹´ë“œ ì¸ì‡„';
        pBtn.innerHTML = 'ğŸ–¨ï¸';
        pBtn.style.cssText = [
          `position:absolute`,
          `left:${boxLeft + BOX_W + 6}px`,
          `top:${cy - 15}px`,
          `width:30px`,`height:30px`,
          `padding:0`,`font-size:0.82rem`,
          `border-radius:50%`,`z-index:5`,
          `display:flex`,`align-items:center`,`justify-content:center`,
        ].join(';');
        pBtn.addEventListener('click', () => printMatchCard(match.id));
        canvas.appendChild(pBtn);
      }
    });
  });

  /* â”€â”€ SVG connector lines â”€â”€ */
  rounds.forEach((_, ri) => {
    if (ri >= rounds.length - 1) return;
    const curr  = centerYs[ri];
    const next  = centerYs[ri + 1];
    const fromX = ri * (COL_W + COL_GAP) + LABEL_W + BOX_W;
    const toX   = (ri + 1) * (COL_W + COL_GAP) + LABEL_W;
    const midX  = fromX + (toX - fromX) / 2;

    for (let i = 0; i < curr.length; i += 2) {
      const y1   = curr[i];
      const y2   = curr[i + 1] ?? y1;
      const midY = (y1 + y2) / 2;
      const yn   = next[Math.floor(i / 2)] ?? midY;

      [`M ${fromX} ${y1} H ${midX} V ${midY}`,
       `M ${fromX} ${y2} H ${midX} V ${midY}`,
       `M ${midX} ${midY} V ${yn} H ${toX}`
      ].forEach(d => {
        const p = document.createElementNS('http://www.w3.org/2000/svg','path');
        p.setAttribute('d', d);
        p.setAttribute('fill', 'none');
        p.setAttribute('stroke', '#c7d2e8');
        p.setAttribute('stroke-width', '1.5');
        p.setAttribute('stroke-linecap', 'round');
        svg.appendChild(p);
      });
    }
  });

  scrollWrap.appendChild(canvas);
  container.appendChild(scrollWrap);

  if (league.tournament.champion) {
    const cb = document.createElement('div');
    cb.className = 'champion-banner';
    cb.innerHTML = `<h3>ğŸ† ìš°ìŠ¹ì</h3><div class="champion-name">${displayName(league, league.tournament.champion)}</div>`;
    container.appendChild(cb);
  }
}

window.selectWinner = function(matchId, playerNum) {
  const league = masterData[curId];
  if (!league.tournament) return;
  let match = null, ri = -1;
  for (let i = 0; i < league.tournament.rounds.length; i++) {
    const m = league.tournament.rounds[i].matches.find(x => x.id === matchId);
    if (m) { match = m; ri = i; break; }
  }
  if (!match) return;

  const winner = playerNum === 1 ? match.player1 : match.player2;
  const winnerSeed = playerNum === 1 ? match.seed1 : match.seed2;
  match.winner = winner; match.completed = true;

  if (ri < league.tournament.rounds.length - 1) {
    const nextRound = league.tournament.rounds[ri + 1];
    const mi = league.tournament.rounds[ri].matches.findIndex(x => x.id === matchId);
    const nmi = Math.floor(mi / 2), pos = mi % 2;
    if (nextRound.matches[nmi]) {
      const nm = nextRound.matches[nmi];
      if (pos === 0) { nm.player1 = winner; nm.seed1 = winnerSeed; }
      else { nm.player2 = winner; nm.seed2 = winnerSeed; }
      // ì²« ë¼ìš´ë“œ ì´í›„ ë¶€ì „ìŠ¹ ìë™ ì²˜ë¦¬ ì—†ìŒ
    }
  } else { league.tournament.champion = winner; }

  save(true); renderTournament();
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ print match card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.printMatchCard = function(matchId) {
  const league = masterData[curId];
  let match = null, roundName = '';
  for (const r of league.tournament.rounds) {
    const f = r.matches.find(m => m.id === matchId);
    if (f) { match = f; roundName = r.name; break; }
  }
  if (!match) return;
  const title = `${league.title || 'ìš©ë¬¸ë¦¬ê·¸'} ${roundName}`;
  const today = new Date().toLocaleDateString('ko-KR');
  const p1 = displayName(league, match.player1) || '';
  const p2 = displayName(league, match.player2) || '';

  const w = window.open('', '_blank', 'width=1100,height=750');
  w.document.write(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title}</title>
<style>
@page { size: A4 landscape; margin: 10mm; }
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;font-family:'Malgun Gothic',sans-serif;}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff;padding:10px;}
.card{width:100%;height:calc(100vh - 20px);display:flex;flex-direction:column;border:2.5px solid #1a1f36;border-radius:12px;overflow:hidden;}
.hd{background:#fff;color:#1a1f36;text-align:center;padding:18px;font-size:26pt;font-weight:900;letter-spacing:-0.5px;flex-shrink:0;border-bottom:2px solid #1a1f36;}
.body{flex:1;display:flex;flex-direction:column;}
.players{display:flex;flex:1;}
.pl{flex:1;display:flex;align-items:center;justify-content:center;font-size:44pt;font-weight:900;color:#1a1f36;text-align:center;padding:16px;word-break:keep-all;}
.pl:first-child{border-right:2px dashed #cbd5e1;}
.score-row{display:flex;flex:2;border-top:2px solid #1a1f36;}
.sc{flex:1;} .sc:first-child{border-right:2px dashed #cbd5e1;}
.ft{background:#fff;padding:10px;text-align:center;font-size:12pt;color:#1a1f36;font-weight:600;border-top:2px solid #e4e8f0;flex-shrink:0;}
.pbtn{display:block;margin:12px auto 0;padding:10px 28px;font-size:13pt;background:#5b6cf5;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
@media print{.pbtn{display:none;}}
</style></head><body>
<div class="card">
  <div class="hd">${title}</div>
  <div class="body">
    <div class="players"><div class="pl">${p1}</div><div class="pl">${p2}</div></div>
    <div class="score-row"><div class="sc"></div><div class="sc"></div></div>
  </div>
  <div class="ft">${today}</div>
</div>
<button class="pbtn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
</body></html>`);
  w.document.close();
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ print group matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.printGroupMatrix = function(gn) {
  const league = masterData[curId];
  const g = league.groups[gn];
  const nMap = {};
  g.names.forEach(n => { nMap[n] = displayName(league, n); });

  // ê²½ê¸° ìˆœì„œ ìƒì„± (ë¦¬ê·¸ ë°©ì‹)
  const schedule = [];
  let list = [...g.names]; if (list.length % 2 === 1) list.push('BYE');
  for (let round = 0; round < list.length - 1; round++) {
    for (let i = 0; i < list.length / 2; i++) {
      const a = list[i], b = list[list.length - 1 - i];
      if (a !== 'BYE' && b !== 'BYE') schedule.push(`${nMap[a]} vs ${nMap[b]}`);
    }
    list.splice(1, 0, list.pop());
  }

  const w = window.open('', '_blank');
  w.document.write(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8">
<title>${league.title} - ${gn}</title>
<style>
@page{size:A4 landscape;margin:9mm;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Malgun Gothic',sans-serif;padding:4mm;}
.page{height:100vh;display:flex;flex-direction:column;}
h2{text-align:center;font-size:20pt;font-weight:900;margin-bottom:12px;}
table{width:100%;border-collapse:collapse;flex:1;}
th,td{border:2px solid #000;padding:${20/(g.names.length+1)}vh 6px;text-align:center;font-size:${90/g.names.length}pt;font-weight:bold;}
th{background:#f0f0f0;}
.pn{text-align:left;padding-left:12px;}
.sched{margin-top:10px;font-size:8pt;font-weight:600;}
.sched-matches{text-align:left;line-height:2;}
.pbtn{display:block;margin:10px auto 0;padding:9px 28px;font-size:13pt;background:#5b6cf5;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
@media print{.pbtn{display:none;}.page{height:auto;}}
</style></head><body>
<div class="page">
  <h2>${league.title} â€” ${gn} ëŒ€ì§„í‘œ</h2>
  <table>
    <thead><tr><th style="width:11%;">ì„ ìˆ˜</th>${g.names.map(n=>`<th style="width:${72/g.names.length}%;">${nMap[n]}</th>`).join('')}<th style="width:8%;">ìŠ¹/íŒ¨</th><th style="width:5%;">ë“ì‹¤</th><th style="width:4%;">ìˆœìœ„</th></tr></thead>
    <tbody>${g.names.map(n1=>`<tr><td class="pn">${nMap[n1]}</td>${g.names.map(n2=>n1===n2?'<td style="background:#e5e7eb;">-</td>':'<td>&nbsp;</td>').join('')}<td>/</td><td>&nbsp;</td><td>&nbsp;</td></tr>`).join('')}</tbody>
  </table>
  <div class="sched">
    <div class="sched-matches">${schedule.join('&nbsp;&nbsp;/&nbsp;&nbsp;')}</div>
  </div>
  <button class="pbtn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
</div></body></html>`);
  w.document.close();
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function save(silent = false) {
  if (!curId) return;
  localStorage.setItem('league_db', JSON.stringify(masterData));
  updateSelector();
  if (!silent) alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function exportJson() {
  if (!Object.keys(masterData).length) { alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const blob = new Blob([JSON.stringify(masterData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `ìš©ë¬¸ë¦¬ê·¸_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function importJson(event, isInitial = false) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      masterData = { ...masterData, ...data };
      localStorage.setItem('league_db', JSON.stringify(masterData));
      updateSelector();
      alert(`âœ… ${Object.keys(data).length}ê°œ ëŒ€íšŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      if (isInitial) document.getElementById('initialImport').classList.add('hidden');
    } catch { alert('âŒ ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.'); }
    event.target.value = '';
  };
  reader.readAsText(file);
}

function updateSelector() {
  const sel = document.getElementById('leagueHistorySelector');
  const ids = Object.keys(masterData).sort((a, b) => masterData[b].date?.localeCompare(masterData[a].date));
  sel.innerHTML = '<option value="">-- ê³¼ê±° ëŒ€íšŒ ì„ íƒ --</option>' +
    ids.map(id => `<option value="${id}">${masterData[id].date} | ${masterData[id].title}</option>`).join('');
}

function renderHistory() {
  const tbody = document.getElementById('histTableBody');
  const ids = Object.keys(masterData).sort((a, b) => masterData[b].date?.localeCompare(masterData[a].date));
  if (!ids.length) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:24px;color:var(--text3);">ì €ì¥ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
  tbody.innerHTML = ids.map(id => `
    <tr>
      <td style="color:var(--text3);white-space:nowrap;">${masterData[id].date}</td>
      <td style="font-weight:700;text-align:left;">${masterData[id].title}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-success-s btn-xs" onclick="handleEdit('${id}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn btn-danger btn-xs" onclick="handleDelete('${id}')" style="margin-left:4px;">ì‚­ì œ</button>
      </td>
    </tr>`).join('');
}

window.handleEdit = id => { closeHistory(); loadLeague(id); };
window.handleDelete = id => {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  delete masterData[id];
  localStorage.setItem('league_db', JSON.stringify(masterData));
  renderHistory(); updateSelector();
  if (curId === id) location.reload();
};
</script>
</body>
</html>